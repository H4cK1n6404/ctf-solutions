# Trendmicro 2018: Analysis Offensive 300

__Tags:__ `crypto`, `rsa`  
__Total Points:__ 300

## Problem Statement

There is going to be a party tommorow. Eva sent an invitation to her friends. Securely, of course!

Download the _message.txt_ file from the link to check the secure invitation message
Download the file

### message.txt

```
message for Alice:
18700320110367574655449823553009212724937318442101140581378358928204994827498139841897479168675123789374462637095265564472109735802305521045676412446455683615469865332270051569768255072111079626023422

Alice's public key (e,N):
( 65537 , 23795719145225386804055015945976331504878851440464956768596487167710701468817080174616923533397144140667518414516928416724767417895751634838329442802874972281385084714429143592029962130216053890866347 )



message for Bob:
27979368157170890767030069060194038526134599497456846620984054211906413024410400026053694007247773572972357106574636186987337336771777265971389911503143036021889778839064900818858188026318442675667707

Bob's public key (e,N):
( 65537 , 46914096084767238967814493997294740286838053572386502727910903794939283633197997427383196569296188299557978279732421725469482678512672280108542428152186999218210536447287087212703368704976239539968977 )



message for Cyril:
24084879450015204136831744759734371350696278325227327049743434712309456808867398488915798176282769616955247276506807739249439515225213919008982824219656080794207250454008942016125074768497986930713993

Cyril's public key (e,N):
( 65537 , 24543003393712692769038137223030855401835344295968717177380639898023646407807465197761211529143336105057325706788229129519925129413109571220297378014990693203802558792781281981621549760273376606206491 )
```

### RSA.sagews

```python
# This code is written in SageMath, which is powerfull math system based on Python
#
# You can download the interpreter here: http://www.sagemath.org
#
# You can use online interpreter here: https://cocalc.com/app (I recommend this option)
#
# Or you can use this file like a "pseudo-code" template to rewrite functions you need into another programming language - the advantage of Python code is, that it's really easy to understand what it should do.


def text2int(text):
    chars = [ord(c) for c in text]
    result  = 0
    for c in chars:
        result *= 256
        result += c
    return result

def int2text(message):
    result=""
    while message>0:
        result = chr(int(message)%int(256))+ result
        message=int(message)/int(256)
    return result



def encrypt(text, e, N):
    text_int = text2int(text)
    encrypted = pow(text_int, e, N)
    return encrypted

def decrypt(x_int, d, N):
    decrypted = pow(x_int, d, N)
    text = int2text(decrypted)
    return text

e  =  65537
```

## Solution

After exhausting common RSA attacks in this form of, such as __Hastad's Broadcast Attack__, I concluded that maybe there should be a way to factorize the public keys, using all messages.

I soon realized that the __N's are not coprime!__, and we can use each one to decompose the public keys completely.

```python
n1 = 23795719145225386804055015945976331504878851440464956768596487167710701468817080174616923533397144140667518414516928416724767417895751634838329442802874972281385084714429143592029962130216053890866347
n2 = 46914096084767238967814493997294740286838053572386502727910903794939283633197997427383196569296188299557978279732421725469482678512672280108542428152186999218210536447287087212703368704976239539968977
n3 = 24543003393712692769038137223030855401835344295968717177380639898023646407807465197761211529143336105057325706788229129519925129413109571220297378014990693203802558792781281981621549760273376606206491

p1 = gcd(n1, n2)
p2 = gcd(n1, n3)
p3 = gcd(n2, n3)

assert n1 == p1*p2
assert n2 == p1*p3
assert n3 == p2*p3
```

From here it is fairly straightforward to decrypt each message to get the flag

`TMCTF{B3Car3fu11Ab0utTh3K3ys}`
## Implementation

```python
c1 = 18700320110367574655449823553009212724937318442101140581378358928204994827498139841897479168675123789374462637095265564472109735802305521045676412446455683615469865332270051569768255072111079626023422
n1 = 23795719145225386804055015945976331504878851440464956768596487167710701468817080174616923533397144140667518414516928416724767417895751634838329442802874972281385084714429143592029962130216053890866347

c2 = 27979368157170890767030069060194038526134599497456846620984054211906413024410400026053694007247773572972357106574636186987337336771777265971389911503143036021889778839064900818858188026318442675667707
n2 = 46914096084767238967814493997294740286838053572386502727910903794939283633197997427383196569296188299557978279732421725469482678512672280108542428152186999218210536447287087212703368704976239539968977

c3 = 24084879450015204136831744759734371350696278325227327049743434712309456808867398488915798176282769616955247276506807739249439515225213919008982824219656080794207250454008942016125074768497986930713993
n3 = 24543003393712692769038137223030855401835344295968717177380639898023646407807465197761211529143336105057325706788229129519925129413109571220297378014990693203802558792781281981621549760273376606206491

def do_decrypt(c, n, n2, n3):
	p = gcd(n, n2)
	q = gcd(n, n3)
	assert p*q == n
	phi = (p-1)*(q-1)
	d = modinv(e, phi)
	print(decrypt(c, d, n))

do_decrypt(c1, n1, n2, n3)
do_decrypt(c2, n2, n1, n3)
do_decrypt(c3, n3, n2, n1)

# Hi Alice, party is tommorow at 8
# Hi Bob, remember, that the flag is TMCTF{B3Car3fu11Ab0utTh3K3ys}
# Hi Cyril, could you bring beer tommorow?
```
